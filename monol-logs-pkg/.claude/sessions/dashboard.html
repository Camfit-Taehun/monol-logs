<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Session Console - monol-logs</title>
  <!-- Monol Design System -->
  <link rel="stylesheet" href="../../../monol-design/monol-design.min.css">
  <style>
    :root {
      /* Monol Design System Colors */
      --bg-primary: var(--monol-bg-base, #0a0a0a);
      --bg-secondary: var(--monol-bg-elevated, #171717);
      --bg-tertiary: var(--monol-bg-surface, #1a1a1a);
      --text-primary: var(--monol-fg-base, #fafafa);
      --text-secondary: var(--monol-fg-muted, #a3a3a3);
      --text-muted: var(--monol-fg-subtle, #737373);
      --border-color: var(--monol-border-base, #262626);
      --accent-blue: var(--monol-info, #3b82f6);
      --accent-green: var(--monol-success, #22c55e);
      --accent-purple: #a855f7;
      --accent-orange: var(--monol-primary, #f97316);
      --accent-red: var(--monol-error, #ef4444);
      --accent-cyan: #06b6d4;
    }

    .light-theme {
      --bg-primary: #ffffff;
      --bg-secondary: #f6f8fa;
      --bg-tertiary: #eaeef2;
      --text-primary: #24292f;
      --text-secondary: #57606a;
      --text-muted: #8c959f;
      --border-color: #d0d7de;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .logo { display: flex; align-items: center; gap: 12px; }
    .logo h1 { font-size: 20px; font-weight: 600; }
    .logo span { color: var(--text-secondary); font-size: 14px; }
    .header-actions { display: flex; gap: 8px; }

    .btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn:hover { background: var(--bg-tertiary); }
    .btn-primary {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: white;
    }
    .btn-primary:hover { opacity: 0.9; }
    .btn svg { width: 16px; height: 16px; vertical-align: -2px; margin-right: 4px; }
    .btn-icon { padding: 6px 8px; }
    .btn-icon svg { margin-right: 0; }

    /* SVG Icons */
    .icon { width: 16px; height: 16px; display: inline-block; vertical-align: -2px; }
    .icon-lg { width: 20px; height: 20px; }
    .stat-card .icon { width: 24px; height: 24px; color: var(--accent-blue); margin-bottom: 8px; }

    /* Filters */
    .filters { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    .filter-group { display: flex; align-items: center; gap: 8px; }
    .filter-group label { font-size: 14px; color: var(--text-secondary); }
    .filter-group select, .filter-group input {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
    }
    .filter-group input { width: 140px; }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }
    .stat-value { font-size: 32px; font-weight: 600; color: var(--accent-blue); }
    .stat-label { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }

    /* Timeline */
    .timeline-section { margin-bottom: 32px; }
    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .timeline-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      overflow-x: auto;
    }
    .timeline { min-width: 600px; }
    .timeline-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .timeline-row { display: flex; align-items: center; margin-bottom: 8px; }
    .timeline-author { width: 100px; font-size: 14px; color: var(--text-secondary); flex-shrink: 0; }
    .timeline-bars {
      flex: 1;
      height: 24px;
      position: relative;
      background: var(--bg-tertiary);
      border-radius: 4px;
    }
    .timeline-bar {
      position: absolute;
      height: 20px;
      top: 2px;
      border-radius: 3px;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    .timeline-bar:hover { opacity: 0.8; }
    .timeline-bar[data-color="blue"] { background: var(--accent-blue); }
    .timeline-bar[data-color="green"] { background: var(--accent-green); }
    .timeline-bar[data-color="purple"] { background: var(--accent-purple); }
    .timeline-bar[data-color="orange"] { background: var(--accent-orange); }
    .timeline-bar[data-color="red"] { background: var(--accent-red); }
    .timeline-bar[data-color="cyan"] { background: var(--accent-cyan); }

    /* Session Cards */
    .sessions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }
    .session-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      transition: border-color 0.15s;
    }
    .session-card:hover { border-color: var(--accent-blue); }
    .session-card.focused { border-color: var(--accent-purple); box-shadow: 0 0 0 2px rgba(163, 113, 247, 0.3); }
    .session-card.expanded { grid-column: 1 / -1; }
    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .session-topic { font-size: 16px; font-weight: 600; word-break: break-word; }
    .session-id { font-size: 12px; color: var(--text-muted); font-family: monospace; }
    .session-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 14px;
      color: var(--text-secondary);
    }
    .session-meta-item { display: flex; align-items: center; gap: 4px; }
    .author-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .author-badge[data-color="blue"] { background: rgba(88, 166, 255, 0.2); color: var(--accent-blue); }
    .author-badge[data-color="green"] { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
    .author-badge[data-color="purple"] { background: rgba(163, 113, 247, 0.2); color: var(--accent-purple); }
    .author-badge[data-color="orange"] { background: rgba(210, 153, 34, 0.2); color: var(--accent-orange); }
    .author-badge[data-color="red"] { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
    .author-badge[data-color="cyan"] { background: rgba(57, 197, 207, 0.2); color: var(--accent-cyan); }

    .session-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .session-actions .btn { text-align: center; padding: 8px 4px; font-size: 13px; }

    /* Preview Section */
    .session-preview {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      display: none;
    }
    .session-preview.show { display: block; }
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .preview-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent-blue);
    }
    .preview-content {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 16px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 14px;
      white-space: pre-wrap;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
    }
    .preview-content h2 { font-size: 16px; margin: 16px 0 8px; color: var(--accent-blue); }
    .preview-content h2:first-child { margin-top: 0; }
    .preview-content ul { margin-left: 20px; }
    .preview-content .user-msg { color: var(--accent-green); }
    .preview-content .assistant-msg { color: var(--accent-purple); }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }
    .modal-overlay.show { opacity: 1; visibility: visible; }
    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 { font-size: 18px; }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
    }
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* Resume Modal */
    .resume-instructions {
      background: var(--bg-tertiary);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .resume-instructions code {
      display: block;
      background: var(--bg-primary);
      padding: 12px;
      border-radius: 6px;
      margin-top: 8px;
      font-family: 'SF Mono', Monaco, monospace;
      color: var(--accent-green);
    }
    .resume-instructions p {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 8px;
    }

    /* Tooltip */
    .tooltip {
      position: fixed;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      max-width: 300px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--accent-green);
      color: white;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s;
      z-index: 1001;
    }
    .toast.show { opacity: 1; transform: translateY(0); }

    /* Empty State */
    .empty-state { text-align: center; padding: 48px; color: var(--text-secondary); }
    .empty-state h3 { margin-bottom: 8px; }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0;
    }
    .tab-btn {
      padding: 12px 20px;
      border: none;
      background: none;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tab-btn:hover { color: var(--text-primary); }
    .tab-btn.active {
      color: var(--accent-blue);
      border-bottom-color: var(--accent-blue);
    }
    .tab-btn svg { width: 16px; height: 16px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Insights Cards */
    .insights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .insight-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
    }
    .insight-card h3 {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .insight-card h3 svg { width: 18px; height: 18px; color: var(--accent-blue); }
    .insight-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }
    .insight-row:last-child { border-bottom: none; }
    .insight-label { color: var(--text-secondary); font-size: 14px; }
    .insight-value { font-weight: 600; font-size: 14px; }
    .insight-bar {
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 4px;
    }
    .insight-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s;
    }
    .knowledge-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
    }
    .knowledge-item:last-child { border-bottom: none; }
    .knowledge-area {
      font-family: monospace;
      font-size: 13px;
      color: var(--accent-cyan);
      min-width: 120px;
    }
    .knowledge-owners { display: flex; gap: 6px; flex-wrap: wrap; }
    .knowledge-owner {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
    }
    .knowledge-owner.primary { background: rgba(88, 166, 255, 0.2); color: var(--accent-blue); }
    .knowledge-owner.secondary { background: var(--bg-tertiary); color: var(--text-secondary); }
    .knowledge-warning {
      color: var(--accent-orange);
      font-size: 11px;
      margin-left: auto;
    }
    .todo-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-color);
    }
    .todo-item:last-child { border-bottom: none; }
    .todo-checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border-color);
      border-radius: 4px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .todo-content { flex: 1; }
    .todo-text { font-size: 14px; margin-bottom: 4px; }
    .todo-meta { font-size: 12px; color: var(--text-muted); }
    .todo-stale { color: var(--accent-orange); }
    .todo-checkbox { cursor: pointer; transition: all 0.2s; }
    .todo-checkbox:hover { border-color: var(--accent-blue); }
    .todo-checkbox.checked {
      background: var(--accent-green);
      border-color: var(--accent-green);
    }
    .todo-checkbox.checked::after {
      content: '✓';
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
    .todo-text.completed {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    /* AI Report Section */
    .report-card { background: linear-gradient(135deg, var(--bg-secondary) 0%, color-mix(in srgb, var(--accent-purple) 5%, var(--bg-secondary)) 100%); }
    .report-description { margin-bottom: 16px; }
    .report-description p { color: var(--text-secondary); margin-bottom: 12px; }
    .report-description ul { list-style: none; padding: 0; margin: 0; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .report-description li {
      font-size: 13px;
      color: var(--text-muted);
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .report-description li::before {
      content: '✦';
      color: var(--accent-purple);
    }
    .report-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }
    .report-actions .btn-primary {
      min-width: 150px;
    }
    .report-select {
      padding: 10px 16px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
    }
    .report-select:focus { outline: none; border-color: var(--accent-purple); }
    .report-preview {
      margin-top: 20px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
    }
    .report-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      font-weight: 500;
    }
    .report-preview-actions { display: flex; gap: 8px; }
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .report-content {
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.7;
    }
    .report-content h1 { font-size: 20px; margin-bottom: 16px; color: var(--text-primary); }
    .report-content h2 { font-size: 16px; margin: 20px 0 12px; color: var(--accent-blue); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
    .report-content h3 { font-size: 14px; margin: 16px 0 8px; color: var(--text-secondary); }
    .report-content p { margin-bottom: 12px; color: var(--text-secondary); }
    .report-content ul, .report-content ol { margin: 8px 0 16px 20px; }
    .report-content li { margin-bottom: 6px; color: var(--text-secondary); }
    .report-content li code { background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; font-size: 12px; }
    .report-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-muted);
    }
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-color);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: -2px;
      margin-right: 4px;
    }
    .report-loading .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent-purple);
      margin-bottom: 16px;
      margin-right: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 16px; }
      header { flex-direction: column; gap: 16px; align-items: flex-start; }
      .filters { flex-direction: column; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .sessions-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <h1>Session Console</h1>
        <span>monol-logs</span>
      </div>
      <div class="header-actions">
        <button class="btn" onclick="showHelpModal()" title="Keyboard shortcuts (?)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          Help
        </button>
        <button class="btn" id="themeBtn" onclick="toggleTheme()" title="Toggle theme (t)">
          <svg id="themeSun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
          <svg id="themeMoon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          Theme
        </button>
        <button class="btn btn-primary" onclick="exportData()" title="Export sessions">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export
        </button>
      </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('sessions')" data-tab="sessions">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Sessions
      </button>
      <button class="tab-btn" onclick="switchTab('insights')" data-tab="insights">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
        Insights
      </button>
    </nav>

    <!-- Sessions Tab -->
    <div id="sessions-tab" class="tab-content active">
    <div class="filters">
      <div class="filter-group">
        <label><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></label>
        <select id="filterAuthor" onchange="applyFilters()">
          <option value="">All Authors</option>
        </select>
      </div>
      <div class="filter-group">
        <label><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></label>
        <input type="date" id="filterDateFrom" onchange="applyFilters()" title="From date">
        <span>~</span>
        <input type="date" id="filterDateTo" onchange="applyFilters()" title="To date">
      </div>
      <div class="filter-group">
        <label><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></label>
        <input type="text" id="filterTopic" placeholder="Search topics... (/)" oninput="applyFilters()">
        <span id="searchCount" style="font-size:12px;color:var(--text-muted);min-width:40px;"></span>
      </div>
      <div class="filter-group">
        <label><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/></svg></label>
        <select id="sortBy" onchange="applyFilters()">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
          <option value="messages">Most messages</option>
          <option value="name">Name A-Z</option>
        </select>
      </div>
      <div class="filter-group">
        <button class="btn btn-icon" id="bookmarkFilterBtn" onclick="toggleBookmarkFilter()" title="Show bookmarked only">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="icon"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
        </button>
      </div>
    </div>

    <div class="stats-grid" id="statsGrid"></div>

    <!-- Charts Section -->
    <section class="charts-section" style="margin-bottom:32px;">
      <h2 class="section-title">Analytics</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;">
        <!-- Hourly Activity -->
        <div class="chart-card" style="background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;padding:16px;">
          <h3 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary);">Hourly Activity</h3>
          <canvas id="hourlyChart" height="120"></canvas>
        </div>
        <!-- Author Contribution -->
        <div class="chart-card" style="background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;padding:16px;">
          <h3 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary);">Author Contribution</h3>
          <div style="display:flex;align-items:center;gap:16px;">
            <canvas id="authorChart" width="120" height="120" style="flex-shrink:0;"></canvas>
            <div id="authorLegend" style="font-size:13px;"></div>
          </div>
        </div>
        <!-- Activity Heatmap -->
        <div class="chart-card" style="background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;padding:16px;grid-column:1/-1;">
          <h3 style="font-size:14px;margin-bottom:12px;color:var(--text-secondary);">Activity Heatmap (Last 52 Weeks)</h3>
          <div id="heatmapContainer" style="overflow-x:auto;">
            <div id="heatmap" style="display:flex;gap:2px;"></div>
          </div>
          <div id="heatmapLegend" style="display:flex;justify-content:flex-end;align-items:center;gap:4px;margin-top:8px;font-size:11px;color:var(--text-muted);">
            Less
            <span style="width:10px;height:10px;background:var(--bg-tertiary);border-radius:2px;"></span>
            <span style="width:10px;height:10px;background:rgba(88,166,255,0.3);border-radius:2px;"></span>
            <span style="width:10px;height:10px;background:rgba(88,166,255,0.5);border-radius:2px;"></span>
            <span style="width:10px;height:10px;background:rgba(88,166,255,0.7);border-radius:2px;"></span>
            <span style="width:10px;height:10px;background:var(--accent-blue);border-radius:2px;"></span>
            More
          </div>
        </div>
      </div>
    </section>

    <section class="timeline-section">
      <h2 class="section-title">Timeline</h2>
      <div class="timeline-container">
        <div class="timeline" id="timeline"></div>
      </div>
    </section>

    <section>
      <h2 class="section-title">Sessions <span id="sessionCount"></span></h2>
      <div class="sessions-grid" id="sessionsGrid"></div>
    </section>
    </div><!-- /sessions-tab -->

    <!-- Insights Tab -->
    <div id="insights-tab" class="tab-content">
      <!-- My Patterns + Team Activity Row -->
      <div class="insights-grid">
        <!-- My Work Patterns -->
        <div class="insight-card">
          <h3>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            My Work Patterns
          </h3>
          <div id="myPatternsContent"></div>
        </div>

        <!-- Team Activity -->
        <div class="insight-card">
          <h3>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Team Contribution
          </h3>
          <div id="teamContributionContent"></div>
        </div>
      </div>

      <!-- Knowledge Map -->
      <div class="insight-card" style="margin-bottom:24px;">
        <h3>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          Knowledge Map
          <span style="margin-left:auto;font-size:12px;color:var(--text-muted);font-weight:normal;">Who knows what</span>
        </h3>
        <div id="knowledgeMapContent"></div>
      </div>

      <!-- Weekly Activity + TODOs Row -->
      <div class="insights-grid">
        <!-- Weekly Activity Chart -->
        <div class="insight-card">
          <h3>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
            Weekly Activity
          </h3>
          <canvas id="weeklyActivityChart" height="150"></canvas>
        </div>

        <!-- Open TODOs -->
        <div class="insight-card">
          <h3>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
            Open TODOs
            <span id="todoCount" style="margin-left:auto;font-size:12px;background:var(--accent-orange);color:white;padding:2px 8px;border-radius:10px;font-weight:normal;"></span>
          </h3>
          <div id="todoListContent" style="max-height:300px;overflow-y:auto;"></div>
        </div>
      </div>

      <!-- Collaboration Insights -->
      <div class="insight-card">
        <h3>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
          Collaboration Insights
        </h3>
        <div id="collaborationContent"></div>
      </div>

      <!-- AI Report Section -->
      <div class="insight-card report-card">
        <h3>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          AI Analysis Report
          <span style="margin-left:8px;font-size:11px;background:var(--accent-purple);color:white;padding:2px 8px;border-radius:10px;font-weight:normal;">AI Powered</span>
        </h3>
        <div class="report-description">
          <p>세션 데이터를 AI가 분석하여 팀 인사이트 리포트를 생성합니다.</p>
          <ul>
            <li>Executive Summary - 핵심 요약</li>
            <li>Team Analysis - 기여도, 지식 맵, 협업 기회</li>
            <li>Technical Debt - TODO 분석</li>
            <li>Recommendations - 제안 사항</li>
          </ul>
        </div>
        <div class="report-actions">
          <select id="reportType" class="report-select">
            <option value="weekly">Weekly Report</option>
            <option value="monthly">Monthly Report</option>
          </select>
          <button class="btn btn-primary" onclick="generateAIReport()" id="generateReportBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            Generate Report
          </button>
        </div>
        <div id="reportPreview" class="report-preview" style="display:none;">
          <div class="report-preview-header">
            <span>Generated Report</span>
            <div class="report-preview-actions">
              <button class="btn btn-small" onclick="copyReport()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                Copy
              </button>
              <button class="btn btn-small" onclick="downloadReport()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Download
              </button>
            </div>
          </div>
          <div id="reportContent" class="report-content"></div>
        </div>
      </div>
    </div><!-- /insights-tab -->
  </div>

  <div class="tooltip" id="tooltip" style="display: none;"></div>
  <div class="toast" id="toast"></div>

  <!-- Help Modal -->
  <div class="modal-overlay" id="helpModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Keyboard Shortcuts</h3>
        <button class="modal-close" onclick="closeModal('helpModal')">&times;</button>
      </div>
      <div class="modal-body">
        <table style="width:100%;font-size:14px;">
          <tr><td style="padding:8px 16px 8px 0;"><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;">?</kbd></td><td>Show this help</td></tr>
          <tr><td style="padding:8px 16px 8px 0;"><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;">t</kbd></td><td>Toggle theme</td></tr>
          <tr><td style="padding:8px 16px 8px 0;"><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;">/</kbd></td><td>Focus search</td></tr>
          <tr><td style="padding:8px 16px 8px 0;"><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;">Esc</kbd></td><td>Close modal / preview</td></tr>
          <tr><td style="padding:8px 16px 8px 0;"><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;">j</kbd> / <kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;">k</kbd></td><td>Navigate sessions</td></tr>
          <tr><td style="padding:8px 16px 8px 0;"><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;">b</kbd></td><td>Toggle bookmark filter</td></tr>
          <tr><td style="padding:8px 16px 8px 0;"><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;">c</kbd></td><td>Compare selected</td></tr>
        </table>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="closeModal('helpModal')">Got it</button>
      </div>
    </div>
  </div>

  <!-- Compare Modal -->
  <div class="modal-overlay" id="compareModal">
    <div class="modal" style="max-width:900px;">
      <div class="modal-header">
        <h3>Compare Sessions</h3>
        <button class="modal-close" onclick="closeModal('compareModal')">&times;</button>
      </div>
      <div class="modal-body" id="compareContent" style="padding:0;">
        <p style="padding:20px;color:var(--text-secondary);">Select 2-4 sessions to compare</p>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('compareModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirm Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal" style="max-width:400px;">
      <div class="modal-header">
        <h3>Delete Session</h3>
        <button class="modal-close" onclick="closeModal('deleteModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p style="color:var(--text-secondary);margin-bottom:16px;">Are you sure you want to delete this session?</p>
        <p id="deleteSessionInfo" style="background:var(--bg-tertiary);padding:12px;border-radius:6px;font-size:14px;"></p>
        <p style="color:var(--accent-red);font-size:13px;margin-top:12px;">This will remove the session from this view. Original files are not affected.</p>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('deleteModal')">Cancel</button>
        <button class="btn" style="background:var(--accent-red);border-color:var(--accent-red);color:white;" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Resume Modal -->
  <div class="modal-overlay" id="resumeModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Resume Session</h3>
        <button class="modal-close" onclick="closeModal('resumeModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="resume-instructions">
          <p>터미널에서 다음 명령어를 실행하세요:</p>
          <code id="resumeCommand">claude --resume session-id</code>
        </div>
        <p style="color: var(--text-secondary); font-size: 14px;">
          또는 Claude Code 내에서 <code style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px;">/session resume &lt;id&gt;</code> 를 입력하세요.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('resumeModal')">Close</button>
        <button class="btn btn-primary" onclick="copyResumeCommand()">Copy Command</button>
      </div>
    </div>
  </div>

  <script>
    // Session data will be injected here (static mode)
    let SESSION_DATA = [{"sessionId":"abcd1234-5678-90ab-cdef-1234567890ab","topic":"test-session","createdAt":"2026-01-22T03:00:00Z","savedAt":"2026-01-22T04:30:00Z","savedBy":"tester","messageCount":25,"hasSummary":true,"hasRoadmap":false}];

    // File contents will be injected here (optional)
    let FILE_CONTENTS = /* FILE_CONTENTS_PLACEHOLDER */{};

    // API Configuration
    const API_BASE = window.CONSOLE_API_BASE || '';  // Empty for static mode
    const USE_API = !!API_BASE;

    // API Client
    const api = {
      async getSessions(params = {}) {
        if (!USE_API) return { sessions: SESSION_DATA, total: SESSION_DATA.length };
        const query = new URLSearchParams(params).toString();
        const res = await fetch(`${API_BASE}/api/sessions?${query}`);
        return res.json();
      },

      async getSession(id) {
        if (!USE_API) return SESSION_DATA.find(s => s.sessionId === id);
        const res = await fetch(`${API_BASE}/api/sessions/${id}`);
        return res.json();
      },

      async getContent(id, type) {
        if (!USE_API) {
          return FILE_CONTENTS[id]?.[type] || null;
        }
        const res = await fetch(`${API_BASE}/api/sessions/${id}/content?type=${type}`);
        const data = await res.json();
        return data.content;
      },

      async deleteSession(id) {
        if (!USE_API) {
          // Static mode: just mark as deleted locally
          deletedSessions.push(id);
          localStorage.setItem('monol-deleted', JSON.stringify(deletedSessions));
          return { success: true };
        }
        const res = await fetch(`${API_BASE}/api/sessions/${id}`, { method: 'DELETE' });
        return res.json();
      },

      async toggleBookmark(id, bookmarked) {
        if (!USE_API) {
          // Static mode: use localStorage
          const idx = bookmarks.indexOf(id);
          if (bookmarked && idx < 0) bookmarks.push(id);
          else if (!bookmarked && idx >= 0) bookmarks.splice(idx, 1);
          localStorage.setItem('monol-bookmarks', JSON.stringify(bookmarks));
          return { sessionId: id, isBookmarked: bookmarked };
        }
        const res = await fetch(`${API_BASE}/api/sessions/${id}/bookmark`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bookmarked })
        });
        return res.json();
      },

      async getStats() {
        if (!USE_API) return null;  // Use local calculation
        const res = await fetch(`${API_BASE}/api/stats`);
        return res.json();
      }
    };

    const COLORS = ['blue', 'green', 'purple', 'orange', 'red', 'cyan'];
    const authorColors = {};
    let currentResumeId = '';
    let currentDeleteId = '';
    let selectedSessions = new Set();
    let bookmarks = JSON.parse(localStorage.getItem('monol-bookmarks') || '[]');
    let bookmarkFilterActive = false;
    let deletedSessions = JSON.parse(localStorage.getItem('monol-deleted') || '[]');
    let focusedSessionIndex = -1;

    // SVG Icons
    const ICONS = {
      sessions: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>',
      users: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
      messages: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
      clock: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
      summary: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
      chat: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>',
      play: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>',
      bookmark: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>',
      bookmarkFilled: '<svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>',
      trash: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
      compare: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>'
    };

    function getAuthorColor(author) {
      if (!authorColors[author]) {
        const idx = Object.keys(authorColors).length % COLORS.length;
        authorColors[author] = COLORS[idx];
      }
      return authorColors[author];
    }

    function parseDate(str) { return new Date(str); }

    function formatDuration(ms) {
      const hours = Math.floor(ms / (1000 * 60 * 60));
      const mins = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      if (hours > 0) return `${hours}h ${mins}m`;
      return `${mins}m`;
    }

    function formatDate(date) {
      return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
    }

    function getFilteredSessions() {
      const authorFilter = document.getElementById('filterAuthor').value;
      const dateFrom = document.getElementById('filterDateFrom').value;
      const dateTo = document.getElementById('filterDateTo').value;
      const topicFilter = document.getElementById('filterTopic').value.toLowerCase();
      const sortBy = document.getElementById('sortBy').value;

      let filtered = SESSION_DATA.filter(s => {
        if (deletedSessions.includes(s.sessionId)) return false;
        if (bookmarkFilterActive && !bookmarks.includes(s.sessionId)) return false;
        if (authorFilter && s.savedBy !== authorFilter) return false;
        if (dateFrom && new Date(s.createdAt) < new Date(dateFrom)) return false;
        if (dateTo && new Date(s.createdAt) > new Date(dateTo + 'T23:59:59')) return false;
        if (topicFilter && !s.topic.toLowerCase().includes(topicFilter)) return false;
        return true;
      });

      // Sort
      switch (sortBy) {
        case 'oldest':
          filtered.sort((a, b) => parseDate(a.createdAt) - parseDate(b.createdAt));
          break;
        case 'messages':
          filtered.sort((a, b) => b.messageCount - a.messageCount);
          break;
        case 'name':
          filtered.sort((a, b) => a.topic.localeCompare(b.topic));
          break;
        default: // newest
          filtered.sort((a, b) => parseDate(b.createdAt) - parseDate(a.createdAt));
      }

      // Update search count
      const countEl = document.getElementById('searchCount');
      if (topicFilter) {
        countEl.textContent = `${filtered.length} found`;
      } else {
        countEl.textContent = '';
      }

      return filtered;
    }

    function renderStats(sessions) {
      const totalMsgs = sessions.reduce((sum, s) => sum + s.messageCount, 0);
      const authors = new Set(sessions.map(s => s.savedBy));
      const totalDuration = sessions.reduce((sum, s) => {
        return sum + (parseDate(s.savedAt) - parseDate(s.createdAt));
      }, 0);
      const bookmarkCount = sessions.filter(s => bookmarks.includes(s.sessionId)).length;

      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card">
          <div class="icon">${ICONS.sessions}</div>
          <div class="stat-value">${sessions.length}</div>
          <div class="stat-label">Sessions</div>
        </div>
        <div class="stat-card">
          <div class="icon">${ICONS.users}</div>
          <div class="stat-value">${authors.size}</div>
          <div class="stat-label">Authors</div>
        </div>
        <div class="stat-card">
          <div class="icon">${ICONS.messages}</div>
          <div class="stat-value">${totalMsgs.toLocaleString()}</div>
          <div class="stat-label">Messages</div>
        </div>
        <div class="stat-card">
          <div class="icon">${ICONS.clock}</div>
          <div class="stat-value">${formatDuration(totalDuration)}</div>
          <div class="stat-label">Total Time</div>
        </div>
        <div class="stat-card" style="cursor:pointer" onclick="toggleBookmarkFilter()" title="Click to filter">
          <div class="icon">${ICONS.bookmarkFilled}</div>
          <div class="stat-value">${bookmarkCount}</div>
          <div class="stat-label">Bookmarked</div>
        </div>
      `;
    }

    function renderTimeline(sessions) {
      if (sessions.length === 0) {
        document.getElementById('timeline').innerHTML = '<div class="empty-state">No sessions to display</div>';
        return;
      }

      const authors = [...new Set(sessions.map(s => s.savedBy))];
      const minDate = Math.min(...sessions.map(s => parseDate(s.createdAt).getTime()));
      const maxDate = Math.max(...sessions.map(s => parseDate(s.savedAt).getTime()));
      const range = maxDate - minDate || 1;

      const dayCount = Math.ceil(range / (24 * 60 * 60 * 1000)) || 1;
      const labelCount = Math.min(dayCount, 7);
      const labelStep = range / labelCount;

      let headerHtml = '<div class="timeline-header">';
      for (let i = 0; i <= labelCount; i++) {
        headerHtml += `<span>${formatDate(new Date(minDate + i * labelStep))}</span>`;
      }
      headerHtml += '</div>';

      let rowsHtml = '';
      authors.forEach(author => {
        const authorSessions = sessions.filter(s => s.savedBy === author);
        const color = getAuthorColor(author);

        let barsHtml = '';
        authorSessions.forEach(s => {
          const start = parseDate(s.createdAt).getTime();
          const end = parseDate(s.savedAt).getTime();
          const left = ((start - minDate) / range) * 100;
          const width = Math.max(((end - start) / range) * 100, 1);

          barsHtml += `<div class="timeline-bar" data-color="${color}"
            style="left: ${left}%; width: ${width}%"
            data-session='${JSON.stringify(s).replace(/'/g, "&#39;")}'
            onmouseenter="showTooltip(event, this)"
            onmouseleave="hideTooltip()"
            onclick="scrollToSession('${s.sessionId}')"></div>`;
        });

        rowsHtml += `
          <div class="timeline-row">
            <div class="timeline-author">${escapeHtml(author)}</div>
            <div class="timeline-bars">${barsHtml}</div>
          </div>
        `;
      });

      document.getElementById('timeline').innerHTML = headerHtml + rowsHtml;
    }

    function renderSessions(sessions) {
      document.getElementById('sessionCount').textContent = `(${sessions.length})`;

      // Show compare button if sessions selected
      const compareBtn = selectedSessions.size >= 2
        ? `<button class="btn btn-primary" onclick="showCompareModal()" style="margin-left:auto;">${ICONS.compare} Compare (${selectedSessions.size})</button>`
        : '';
      document.querySelector('section:last-child .section-title').innerHTML = `Sessions <span id="sessionCount">(${sessions.length})</span> ${compareBtn}`;

      if (sessions.length === 0) {
        document.getElementById('sessionsGrid').innerHTML = `
          <div class="empty-state">
            <h3>No sessions found</h3>
            <p>Try adjusting your filters</p>
          </div>
        `;
        return;
      }

      document.getElementById('sessionsGrid').innerHTML = sessions.map((s, idx) => {
        const created = parseDate(s.createdAt);
        const saved = parseDate(s.savedAt);
        const duration = formatDuration(saved - created);
        const color = getAuthorColor(s.savedBy);
        const shortId = s.sessionId.substring(0, 8);
        const isBookmarked = bookmarks.includes(s.sessionId);
        const isSelected = selectedSessions.has(s.sessionId);
        const isFocused = idx === focusedSessionIndex;

        return `
          <div class="session-card ${isFocused ? 'focused' : ''}" id="session-${s.sessionId}" data-session-id="${s.sessionId}" data-index="${idx}">
            <div class="session-header">
              <div style="display:flex;align-items:flex-start;gap:8px;">
                <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelectSession('${s.sessionId}')" title="Select for compare" style="margin-top:4px;cursor:pointer;">
                <div>
                  <div class="session-topic">${escapeHtml(s.topic)}</div>
                  <div class="session-id">${shortId}</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:8px;">
                <button class="btn btn-icon" onclick="toggleBookmark('${s.sessionId}')" title="${isBookmarked ? 'Remove bookmark' : 'Add bookmark'}" style="color:${isBookmarked ? 'var(--accent-orange)' : 'inherit'}">
                  ${isBookmarked ? ICONS.bookmarkFilled : ICONS.bookmark}
                </button>
                <span class="author-badge" data-color="${color}">${escapeHtml(s.savedBy)}</span>
              </div>
            </div>
            <div class="session-meta">
              <span class="session-meta-item">${created.toLocaleDateString('ko-KR')}</span>
              <span class="session-meta-item">${created.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})}</span>
              <span class="session-meta-item">${duration}</span>
              <span class="session-meta-item">${s.messageCount} msgs</span>
            </div>
            <div class="session-actions">
              <button class="btn" onclick="togglePreview('${s.sessionId}', 'summary')">${ICONS.summary} Summary</button>
              <button class="btn" onclick="togglePreview('${s.sessionId}', 'conversation')">${ICONS.chat} Chat</button>
              <button class="btn btn-primary" onclick="showResumeModal('${s.sessionId}')">${ICONS.play} Resume</button>
              <button class="btn btn-icon" onclick="showDeleteModal('${s.sessionId}')" title="Delete" style="color:var(--accent-red);">${ICONS.trash}</button>
            </div>
            <div class="session-preview" id="preview-${s.sessionId}">
              <div class="preview-header">
                <span class="preview-title" id="preview-title-${s.sessionId}">Summary</span>
                <button class="btn" style="padding:4px 8px;font-size:12px" onclick="closePreview('${s.sessionId}')">Close</button>
              </div>
              <div class="preview-content" id="preview-content-${s.sessionId}">
                Loading...
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function togglePreview(sessionId, type) {
      const preview = document.getElementById(`preview-${sessionId}`);
      const card = document.getElementById(`session-${sessionId}`);
      const titleEl = document.getElementById(`preview-title-${sessionId}`);
      const isShown = preview.classList.contains('show');
      const currentType = preview.dataset.currentType;

      // If same type is clicked again, close it
      if (isShown && currentType === type) {
        closePreview(sessionId);
        return;
      }

      // Close all other previews
      document.querySelectorAll('.session-preview.show').forEach(p => {
        if (p.id !== `preview-${sessionId}`) {
          p.classList.remove('show');
          p.closest('.session-card').classList.remove('expanded');
        }
      });

      // Show preview and set title
      preview.classList.add('show');
      card.classList.add('expanded');
      preview.dataset.currentType = type;
      titleEl.textContent = type === 'summary' ? 'Summary' : 'Conversation';
      loadPreviewContent(sessionId, type);
    }

    function closePreview(sessionId) {
      const preview = document.getElementById(`preview-${sessionId}`);
      const card = document.getElementById(`session-${sessionId}`);
      preview.classList.remove('show');
      card.classList.remove('expanded');
      delete preview.dataset.currentType;
    }

    async function loadPreviewContent(sessionId, type) {
      const contentEl = document.getElementById(`preview-content-${sessionId}`);
      const session = SESSION_DATA.find(s => s.sessionId === sessionId);

      contentEl.innerHTML = '<div style="color:var(--text-muted)">Loading...</div>';

      try {
        // Try API first, then local cache
        const content = await api.getContent(sessionId, type);

        if (content) {
          // Cache it locally
          if (!FILE_CONTENTS[sessionId]) FILE_CONTENTS[sessionId] = {};
          FILE_CONTENTS[sessionId][type] = content;
          contentEl.innerHTML = formatPreviewContent(content, type);
        } else {
          // Generate placeholder content
          if (type === 'summary') {
            contentEl.innerHTML = generateMockSummary(session);
          } else {
            contentEl.innerHTML = generateMockConversation(session);
          }
        }
      } catch (e) {
        console.error('Failed to load content:', e);
        // Fallback to mock
        if (type === 'summary') {
          contentEl.innerHTML = generateMockSummary(session);
        } else {
          contentEl.innerHTML = generateMockConversation(session);
        }
      }
    }

    function generateMockSummary(session) {
      return `<h2>Session Summary</h2>
<strong>Session:</strong> ${escapeHtml(session.topic)} (${session.sessionId.substring(0, 8)})
<strong>Date:</strong> ${new Date(session.createdAt).toLocaleDateString('ko-KR')}
<strong>Author:</strong> ${escapeHtml(session.savedBy)}
<strong>Messages:</strong> ${session.messageCount}

<h2>주요 작업</h2>
<ul>
<li>세션 내용 기반 작업 요약</li>
<li>구현된 기능 목록</li>
<li>해결된 이슈</li>
</ul>

<h2>다음 할 일</h2>
<ul>
<li>[ ] 후속 작업 항목</li>
<li>[ ] 테스트 추가</li>
</ul>

<em style="color: var(--text-muted);">실제 요약은 .summary.md 파일에서 로드됩니다.</em>`;
    }

    function generateMockConversation(session) {
      return `<h2>Session: ${escapeHtml(session.topic)}</h2>
Date: ${new Date(session.createdAt).toLocaleDateString('ko-KR')}
Author: ${escapeHtml(session.savedBy)}
Messages: ${session.messageCount}

---

<span class="user-msg">## 👤 User</span>
첫 번째 사용자 메시지 예시...

<span class="assistant-msg">## 🤖 Assistant</span>
첫 번째 어시스턴트 응답 예시...

<span class="user-msg">## 👤 User</span>
두 번째 사용자 메시지...

<span class="assistant-msg">## 🤖 Assistant</span>
두 번째 어시스턴트 응답...

---
<em style="color: var(--text-muted);">전체 대화는 .conversation.md 파일에서 로드됩니다.</em>`;
    }

    function formatPreviewContent(content, type) {
      // Basic markdown-like formatting
      let html = escapeHtml(content);
      html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
      html = html.replace(/^# (.+)$/gm, '<h2 style="font-size:18px">$1</h2>');
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/^- \[ \] (.+)$/gm, '<li>☐ $1</li>');
      html = html.replace(/^- \[x\] (.+)$/gm, '<li>☑ $1</li>');
      html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
      html = html.replace(/👤 User/g, '<span class="user-msg">👤 User</span>');
      html = html.replace(/🤖 Assistant/g, '<span class="assistant-msg">🤖 Assistant</span>');
      return html;
    }

    function showResumeModal(sessionId) {
      const session = SESSION_DATA.find(s => s.sessionId === sessionId);
      currentResumeId = sessionId;
      document.getElementById('resumeCommand').textContent = `claude --resume ${sessionId}`;
      document.getElementById('resumeModal').classList.add('show');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
    }

    function copyResumeCommand() {
      const cmd = `claude --resume ${currentResumeId}`;
      navigator.clipboard.writeText(cmd).then(() => {
        showToast('Copied: ' + cmd);
        closeModal('resumeModal');
      });
    }

    function populateAuthorFilter() {
      const authors = [...new Set(SESSION_DATA.map(s => s.savedBy))];
      const select = document.getElementById('filterAuthor');
      authors.forEach(author => {
        const option = document.createElement('option');
        option.value = author;
        option.textContent = author;
        select.appendChild(option);
      });
    }

    // Tab switching
    let currentTab = 'sessions';

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `${tab}-tab`);
      });

      if (tab === 'insights') {
        renderInsights(SESSION_DATA);
      }
    }

    // Mock TODO data (would come from roadmap.md files)
    const MOCK_TODOS = [
      { text: 'Add unit tests for auth module', session: 'login-feature', author: 'alice', daysAgo: 3 },
      { text: 'Implement password reset flow', session: 'login-feature', author: 'alice', daysAgo: 3 },
      { text: 'Optimize database queries', session: 'api-refactor', author: 'bob', daysAgo: 7 },
      { text: 'Add rate limiting to API', session: 'api-refactor', author: 'bob', daysAgo: 7 },
      { text: 'Fix memory leak in dashboard', session: 'dashboard-improvement', author: 'alice', daysAgo: 1 },
      { text: 'Add export to CSV feature', session: 'dashboard-improvement', author: 'alice', daysAgo: 1 },
      { text: 'Update API documentation', session: 'documentation-update', author: 'bob', daysAgo: 14 },
      { text: 'Review security audit findings', session: 'bug-fix-auth', author: 'charlie', daysAgo: 10 },
    ];

    // Mock knowledge areas (derived from topics)
    function deriveKnowledgeAreas(sessions) {
      const areas = {};
      sessions.forEach(s => {
        // Extract area from topic (simplified)
        let area = s.topic.split('-')[0];
        if (s.topic.includes('auth') || s.topic.includes('login')) area = 'auth/*';
        else if (s.topic.includes('api')) area = 'api/*';
        else if (s.topic.includes('dashboard') || s.topic.includes('ui')) area = 'frontend/*';
        else if (s.topic.includes('doc')) area = 'docs/*';
        else area = s.topic;

        if (!areas[area]) areas[area] = {};
        areas[area][s.savedBy] = (areas[area][s.savedBy] || 0) + 1;
      });
      return areas;
    }

    async function renderInsights(sessions) {
      // Try to load from API first (server mode)
      if (USE_API) {
        try {
          const response = await fetch(`${API_BASE}/api/insights`);
          if (response.ok) {
            const data = await response.json();
            renderMyPatternsFromAPI(data.personal);
            renderTeamContributionFromAPI(data.team);
            renderKnowledgeMapFromAPI(data.team.knowledgeMap, data.team.silos);
            renderWeeklyActivityChartFromAPI(data.team.weeklyActivity);
            renderTodoListFromAPI(data.todos);
            renderCollaborationInsightsFromAPI(data.team);
            return;
          }
        } catch (e) {
          console.warn('Failed to load insights from API, using local data:', e);
        }
      }

      // Fallback to local calculation
      renderMyPatterns(sessions);
      renderTeamContribution(sessions);
      renderKnowledgeMap(sessions);
      renderWeeklyActivityChart(sessions);
      renderTodoList();
      renderCollaborationInsights(sessions);
    }

    // API-based rendering functions
    function renderMyPatternsFromAPI(personal) {
      document.getElementById('myPatternsContent').innerHTML = `
        <div class="insight-row">
          <span class="insight-label">Peak Hours</span>
          <span class="insight-value">${personal.peakHour}</span>
        </div>
        <div class="insight-row">
          <span class="insight-label">Most Active Day</span>
          <span class="insight-value">${personal.peakDay}</span>
        </div>
        <div class="insight-row">
          <span class="insight-label">Avg Session</span>
          <span class="insight-value">${personal.avgSessionDuration}m</span>
        </div>
        <div class="insight-row">
          <span class="insight-label">Total Sessions</span>
          <span class="insight-value">${personal.totalSessions}</span>
        </div>
      `;
    }

    function renderTeamContributionFromAPI(team) {
      const total = Object.values(team.authorSessions).reduce((a, b) => a + b, 0) || 1;
      const sorted = Object.entries(team.authorSessions).sort((a, b) => b[1] - a[1]);
      const colorMap = { blue: '#58a6ff', green: '#3fb950', purple: '#a371f7', orange: '#d29922', red: '#f85149', cyan: '#39c5cf' };

      document.getElementById('teamContributionContent').innerHTML = sorted.map(([author, count]) => {
        const pct = Math.round((count / total) * 100);
        const color = colorMap[getAuthorColor(author)] || '#58a6ff';
        return `
          <div style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
              <span style="font-size:14px;">${escapeHtml(author)}</span>
              <span style="font-size:14px;color:var(--text-muted);">${count} sessions (${pct}%)</span>
            </div>
            <div class="insight-bar">
              <div class="insight-bar-fill" style="width:${pct}%;background:${color};"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderKnowledgeMapFromAPI(knowledgeMap, silos) {
      const colorMap = { blue: '#58a6ff', green: '#3fb950', purple: '#a371f7', orange: '#d29922', red: '#f85149', cyan: '#39c5cf' };
      const siloAreas = new Set(silos.map(s => s.area));

      const html = Object.entries(knowledgeMap).map(([area, data]) => {
        const sorted = data.contributors.map(c => [c, c === data.primary ? 999 : 1]).sort((a, b) => b[1] - a[1]);
        const isSoleOwner = siloAreas.has(area);

        return `
          <div class="knowledge-item">
            <span class="knowledge-area">${escapeHtml(area)}/*</span>
            <div class="knowledge-owners">
              ${sorted.map(([author], idx) => {
                const color = colorMap[getAuthorColor(author)] || '#58a6ff';
                const isPrimary = author === data.primary;
                return `<span class="knowledge-owner ${isPrimary ? 'primary' : 'secondary'}" style="${isPrimary ? `background:${color}22;color:${color}` : ''}">${escapeHtml(author)}</span>`;
              }).join('')}
            </div>
            ${isSoleOwner ? '<span class="knowledge-warning">⚠️ sole owner</span>' : ''}
          </div>
        `;
      }).join('');

      document.getElementById('knowledgeMapContent').innerHTML = html || '<div class="empty-state"><p>No knowledge areas detected</p></div>';
    }

    function renderWeeklyActivityChartFromAPI(weeklyActivity) {
      const canvas = document.getElementById('weeklyActivityChart');
      const ctx = canvas.getContext('2d');
      const width = canvas.parentElement.clientWidth - 40;
      canvas.width = width;

      const allAuthors = new Set();
      weeklyActivity.forEach(day => {
        Object.keys(day.byAuthor).forEach(a => allAuthors.add(a));
      });
      const authors = [...allAuthors];

      const barWidth = (width - 60) / 7;
      const maxPerDay = Math.max(...weeklyActivity.map(d => d.total), 1);
      const chartHeight = 120;
      const colorMap = { blue: '#58a6ff', green: '#3fb950', purple: '#a371f7', orange: '#d29922', red: '#f85149', cyan: '#39c5cf' };

      ctx.clearRect(0, 0, width, 150);

      weeklyActivity.forEach((dayData, i) => {
        const x = 30 + i * barWidth;
        let y = chartHeight;

        authors.forEach(author => {
          const count = dayData.byAuthor[author] || 0;
          if (count > 0) {
            const height = (count / maxPerDay) * chartHeight;
            const color = colorMap[getAuthorColor(author)] || '#58a6ff';
            ctx.fillStyle = color;
            ctx.fillRect(x + 5, y - height, barWidth - 10, height);
            y -= height;
          }
        });

        // Day label
        ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-muted').trim() || '#6e7681';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(dayData.day, x + barWidth / 2, chartHeight + 15);
      });
    }

    function renderTodoListFromAPI(todoData) {
      const todos = todoData.items || [];
      document.getElementById('todoCount').textContent = todoData.open || todos.length;

      const now = new Date();
      document.getElementById('todoListContent').innerHTML = todos.map(todo => {
        const createdDate = new Date(todo.createdAt);
        const daysAgo = Math.floor((now - createdDate) / (1000 * 60 * 60 * 24));
        const isStale = daysAgo > 14;
        return `
          <div class="todo-item" data-todo-id="${todo.id}">
            <div class="todo-checkbox ${todo.completed ? 'checked' : ''}" onclick="toggleTodo(${todo.id})"></div>
            <div class="todo-content">
              <div class="todo-text ${todo.completed ? 'completed' : ''}">${escapeHtml(todo.content)}</div>
              <div class="todo-meta ${isStale ? 'todo-stale' : ''}">
                ${escapeHtml(todo.session)} · ${escapeHtml(todo.author)} · ${daysAgo}d ago
                ${isStale ? ' ⚠️' : ''}
                ${todo.priority === 'high' ? ' <span style="color:var(--accent-red);">●</span>' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('') || '<div class="empty-state"><p>No open TODOs</p></div>';
    }

    async function toggleTodo(id) {
      if (!USE_API) return;
      try {
        const response = await fetch(`${API_BASE}/api/insights/todos/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ completed: true })
        });
        if (response.ok) {
          renderInsights(SESSION_DATA);
        }
      } catch (e) {
        console.error('Failed to toggle todo:', e);
      }
    }

    function renderCollaborationInsightsFromAPI(team) {
      let html = '';

      if (team.hotTopics && team.hotTopics.length > 0) {
        html += `
          <div style="margin-bottom:16px;">
            <div style="font-size:13px;color:var(--accent-green);margin-bottom:8px;">🔥 Hot Topics (Multiple Contributors)</div>
            ${team.hotTopics.slice(0, 3).map(ht => `
              <div style="padding:8px 12px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:8px;">
                <strong>${escapeHtml(ht.area)}</strong>
                <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">
                  Contributors: ${ht.contributors.map(a => escapeHtml(a)).join(', ')} (${ht.sessionCount} sessions)
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      if (team.silos && team.silos.length > 0) {
        html += `
          <div>
            <div style="font-size:13px;color:var(--accent-orange);margin-bottom:8px;">⚠️ Knowledge Silos (Single Owner)</div>
            <div style="font-size:13px;color:var(--text-secondary);">
              ${team.silos.slice(0, 5).map(s => `
                <span style="display:inline-block;padding:4px 8px;background:var(--bg-tertiary);border-radius:4px;margin:2px;">${escapeHtml(s.area)} → ${escapeHtml(s.owner)}</span>
              `).join('')}
              ${team.silos.length > 5 ? `<span style="color:var(--text-muted);"> +${team.silos.length - 5} more</span>` : ''}
            </div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:8px;">
              💡 Consider knowledge sharing sessions for these areas
            </div>
          </div>
        `;
      }

      if ((!team.hotTopics || !team.hotTopics.length) && (!team.silos || !team.silos.length)) {
        html = '<div class="empty-state"><p>Not enough data for collaboration insights</p></div>';
      }

      document.getElementById('collaborationContent').innerHTML = html;
    }

    // =====================
    // AI Report Functions
    // =====================

    let currentReport = '';

    async function generateAIReport() {
      const reportType = document.getElementById('reportType').value;
      const btn = document.getElementById('generateReportBtn');
      const preview = document.getElementById('reportPreview');
      const content = document.getElementById('reportContent');

      // Show loading state
      btn.disabled = true;
      btn.innerHTML = `<span class="spinner"></span>Generating...`;
      preview.style.display = 'block';
      content.innerHTML = `
        <div class="report-loading">
          <div class="spinner"></div>
          <p>AI가 세션 데이터를 분석하고 있습니다...</p>
          <p style="font-size:12px;">잠시만 기다려주세요.</p>
        </div>
      `;

      try {
        const response = await fetch(`${API_BASE}/api/insights/report`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: reportType })
        });

        if (!response.ok) {
          throw new Error('Failed to generate report');
        }

        const data = await response.json();
        currentReport = data.content;

        // Render markdown content
        content.innerHTML = renderMarkdown(data.content);
        showToast('Report generated successfully!');
      } catch (error) {
        console.error('Error generating report:', error);
        content.innerHTML = `
          <div class="report-loading" style="color:var(--accent-red);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="40" height="40" style="margin-bottom:16px;">
              <circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <p>리포트 생성에 실패했습니다.</p>
            <p style="font-size:12px;">잠시 후 다시 시도해주세요.</p>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.innerHTML = `
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          Generate Report
        `;
      }
    }

    // Simple markdown to HTML renderer
    function renderMarkdown(md) {
      return md
        // Headers
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        // Bold
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Italic
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // Code
        .replace(/`(.*?)`/g, '<code>$1</code>')
        // Unordered lists
        .replace(/^\- \[ \] (.*$)/gm, '<li style="list-style:none;"><input type="checkbox" disabled> $1</li>')
        .replace(/^\- \[x\] (.*$)/gm, '<li style="list-style:none;"><input type="checkbox" checked disabled> $1</li>')
        .replace(/^\- (.*$)/gm, '<li>$1</li>')
        // Numbered lists
        .replace(/^\d+\. (.*$)/gm, '<li>$1</li>')
        // Paragraphs
        .replace(/\n\n/g, '</p><p>')
        // Line breaks
        .replace(/\n/g, '<br>')
        // Wrap in paragraph
        .replace(/^(.+)$/gm, (match) => {
          if (match.startsWith('<h') || match.startsWith('<li') || match.startsWith('<ul') || match.startsWith('<ol')) {
            return match;
          }
          return match;
        });
    }

    function copyReport() {
      if (!currentReport) {
        showToast('No report to copy');
        return;
      }
      navigator.clipboard.writeText(currentReport).then(() => {
        showToast('Report copied to clipboard!');
      }).catch(() => {
        showToast('Failed to copy report');
      });
    }

    function downloadReport() {
      if (!currentReport) {
        showToast('No report to download');
        return;
      }
      const reportType = document.getElementById('reportType').value;
      const date = new Date().toISOString().split('T')[0];
      const filename = `insights-report-${reportType}-${date}.md`;

      const blob = new Blob([currentReport], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast(`Downloaded ${filename}`);
    }

    function renderMyPatterns(sessions) {
      // Get current user (first author as mock)
      const currentUser = sessions[0]?.savedBy || 'unknown';
      const mySessions = sessions.filter(s => s.savedBy === currentUser);

      // Calculate patterns
      const hourCounts = new Array(24).fill(0);
      const dayCounts = new Array(7).fill(0);
      let totalDuration = 0;

      mySessions.forEach(s => {
        const created = new Date(s.createdAt);
        hourCounts[created.getHours()]++;
        dayCounts[created.getDay()]++;
        totalDuration += new Date(s.savedAt) - created;
      });

      // Find peak hours
      const peakHour = hourCounts.indexOf(Math.max(...hourCounts));
      const peakHourEnd = (peakHour + 4) % 24;

      // Find most active day
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const peakDay = dayCounts.indexOf(Math.max(...dayCounts));

      // Average session duration
      const avgDuration = mySessions.length > 0 ? totalDuration / mySessions.length : 0;

      document.getElementById('myPatternsContent').innerHTML = `
        <div class="insight-row">
          <span class="insight-label">Peak Hours</span>
          <span class="insight-value">${String(peakHour).padStart(2, '0')}:00 - ${String(peakHourEnd).padStart(2, '0')}:00</span>
        </div>
        <div class="insight-row">
          <span class="insight-label">Most Active Day</span>
          <span class="insight-value">${dayNames[peakDay]}</span>
        </div>
        <div class="insight-row">
          <span class="insight-label">Avg Session</span>
          <span class="insight-value">${formatDuration(avgDuration)}</span>
        </div>
        <div class="insight-row">
          <span class="insight-label">Total Sessions</span>
          <span class="insight-value">${mySessions.length}</span>
        </div>
        <div class="insight-row">
          <span class="insight-label">This Week</span>
          <span class="insight-value">${mySessions.filter(s => {
            const d = new Date(s.createdAt);
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            return d >= weekAgo;
          }).length} sessions</span>
        </div>
      `;
    }

    function renderTeamContribution(sessions) {
      const authorCounts = {};
      sessions.forEach(s => {
        authorCounts[s.savedBy] = (authorCounts[s.savedBy] || 0) + 1;
      });

      const total = sessions.length || 1;
      const sorted = Object.entries(authorCounts).sort((a, b) => b[1] - a[1]);
      const colorMap = { blue: '#58a6ff', green: '#3fb950', purple: '#a371f7', orange: '#d29922', red: '#f85149', cyan: '#39c5cf' };

      document.getElementById('teamContributionContent').innerHTML = sorted.map(([author, count]) => {
        const pct = Math.round((count / total) * 100);
        const color = colorMap[getAuthorColor(author)] || '#58a6ff';
        return `
          <div style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
              <span style="font-size:14px;">${escapeHtml(author)}</span>
              <span style="font-size:14px;color:var(--text-muted);">${count} sessions (${pct}%)</span>
            </div>
            <div class="insight-bar">
              <div class="insight-bar-fill" style="width:${pct}%;background:${color};"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderKnowledgeMap(sessions) {
      const areas = deriveKnowledgeAreas(sessions);
      const colorMap = { blue: '#58a6ff', green: '#3fb950', purple: '#a371f7', orange: '#d29922', red: '#f85149', cyan: '#39c5cf' };

      const html = Object.entries(areas).map(([area, owners]) => {
        const sorted = Object.entries(owners).sort((a, b) => b[1] - a[1]);
        const isSoleOwner = sorted.length === 1;

        return `
          <div class="knowledge-item">
            <span class="knowledge-area">${escapeHtml(area)}</span>
            <div class="knowledge-owners">
              ${sorted.map(([author, count], idx) => {
                const color = colorMap[getAuthorColor(author)] || '#58a6ff';
                const isPrimary = idx === 0;
                return `<span class="knowledge-owner ${isPrimary ? 'primary' : 'secondary'}" style="${isPrimary ? `background:${color}22;color:${color}` : ''}">${escapeHtml(author)} (${count})</span>`;
              }).join('')}
            </div>
            ${isSoleOwner ? '<span class="knowledge-warning">⚠️ sole owner</span>' : ''}
          </div>
        `;
      }).join('');

      document.getElementById('knowledgeMapContent').innerHTML = html || '<div class="empty-state"><p>No knowledge areas detected</p></div>';
    }

    function renderWeeklyActivityChart(sessions) {
      const canvas = document.getElementById('weeklyActivityChart');
      const ctx = canvas.getContext('2d');
      const width = canvas.parentElement.clientWidth - 40;
      canvas.width = width;

      // Group by day of week and author
      const authors = [...new Set(sessions.map(s => s.savedBy))];
      const dayData = {};
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

      dayNames.forEach(day => {
        dayData[day] = {};
        authors.forEach(a => dayData[day][a] = 0);
      });

      sessions.forEach(s => {
        const day = dayNames[new Date(s.createdAt).getDay()];
        dayData[day][s.savedBy]++;
      });

      const barWidth = (width - 60) / 7;
      const maxPerDay = Math.max(...dayNames.map(d => Object.values(dayData[d]).reduce((a, b) => a + b, 0)), 1);
      const chartHeight = 120;
      const colorMap = { blue: '#58a6ff', green: '#3fb950', purple: '#a371f7', orange: '#d29922', red: '#f85149', cyan: '#39c5cf' };

      ctx.clearRect(0, 0, width, 150);

      dayNames.forEach((day, i) => {
        const x = 30 + i * barWidth;
        let y = chartHeight;

        authors.forEach(author => {
          const count = dayData[day][author];
          if (count > 0) {
            const height = (count / maxPerDay) * chartHeight;
            const color = colorMap[getAuthorColor(author)] || '#58a6ff';
            ctx.fillStyle = color;
            ctx.fillRect(x + 5, y - height, barWidth - 10, height);
            y -= height;
          }
        });

        // Day label
        ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-muted').trim() || '#6e7681';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(day, x + barWidth / 2, chartHeight + 15);
      });
    }

    function renderTodoList() {
      const todos = MOCK_TODOS;
      document.getElementById('todoCount').textContent = todos.length;

      document.getElementById('todoListContent').innerHTML = todos.map(todo => {
        const isStale = todo.daysAgo > 7;
        return `
          <div class="todo-item">
            <div class="todo-checkbox"></div>
            <div class="todo-content">
              <div class="todo-text">${escapeHtml(todo.text)}</div>
              <div class="todo-meta ${isStale ? 'todo-stale' : ''}">
                ${escapeHtml(todo.session)} · ${escapeHtml(todo.author)} · ${todo.daysAgo}d ago
                ${isStale ? ' ⚠️' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderCollaborationInsights(sessions) {
      // Find hot topics (multiple authors)
      const topicAuthors = {};
      sessions.forEach(s => {
        if (!topicAuthors[s.topic]) topicAuthors[s.topic] = new Set();
        topicAuthors[s.topic].add(s.savedBy);
      });

      const hotTopics = Object.entries(topicAuthors)
        .filter(([_, authors]) => authors.size > 1)
        .map(([topic, authors]) => ({ topic, authors: [...authors] }));

      // Find knowledge silos
      const silos = Object.entries(topicAuthors)
        .filter(([_, authors]) => authors.size === 1)
        .map(([topic, authors]) => ({ topic, author: [...authors][0] }));

      let html = '';

      if (hotTopics.length > 0) {
        html += `
          <div style="margin-bottom:16px;">
            <div style="font-size:13px;color:var(--accent-green);margin-bottom:8px;">🔥 Hot Topics (Multiple Contributors)</div>
            ${hotTopics.slice(0, 3).map(ht => `
              <div style="padding:8px 12px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:8px;">
                <strong>${escapeHtml(ht.topic)}</strong>
                <div style="font-size:12px;color:var(--text-muted);margin-top:4px;">
                  Contributors: ${ht.authors.map(a => escapeHtml(a)).join(', ')}
                </div>
              </div>
            `).join('')}
          </div>
        `;
      }

      if (silos.length > 0) {
        html += `
          <div>
            <div style="font-size:13px;color:var(--accent-orange);margin-bottom:8px;">⚠️ Knowledge Silos (Single Owner)</div>
            <div style="font-size:13px;color:var(--text-secondary);">
              ${silos.slice(0, 5).map(s => `
                <span style="display:inline-block;padding:4px 8px;background:var(--bg-tertiary);border-radius:4px;margin:2px;">${escapeHtml(s.topic)} → ${escapeHtml(s.author)}</span>
              `).join('')}
              ${silos.length > 5 ? `<span style="color:var(--text-muted);"> +${silos.length - 5} more</span>` : ''}
            </div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:8px;">
              💡 Consider knowledge sharing sessions for these areas
            </div>
          </div>
        `;
      }

      if (!hotTopics.length && !silos.length) {
        html = '<div class="empty-state"><p>Not enough data for collaboration insights</p></div>';
      }

      document.getElementById('collaborationContent').innerHTML = html;
    }

    function applyFilters() {
      const filtered = getFilteredSessions();
      renderStats(filtered);
      renderCharts(filtered);
      renderTimeline(filtered);
      renderSessions(filtered);
    }

    function renderCharts(sessions) {
      renderHourlyChart(sessions);
      renderAuthorChart(sessions);
      renderHeatmap(sessions);
    }

    function renderHourlyChart(sessions) {
      const canvas = document.getElementById('hourlyChart');
      const ctx = canvas.getContext('2d');
      const width = canvas.parentElement.clientWidth - 32;
      canvas.width = width;

      // Count sessions by hour
      const hourly = new Array(24).fill(0);
      sessions.forEach(s => {
        const hour = parseDate(s.createdAt).getHours();
        hourly[hour]++;
      });

      const maxVal = Math.max(...hourly, 1);
      const barWidth = (width - 48) / 24;
      const chartHeight = 100;

      ctx.clearRect(0, 0, width, 120);

      // Draw bars
      hourly.forEach((count, i) => {
        const barHeight = (count / maxVal) * chartHeight;
        const x = 24 + i * barWidth;
        const y = chartHeight - barHeight;

        ctx.fillStyle = count > 0 ? 'rgba(88, 166, 255, 0.7)' : 'rgba(88, 166, 255, 0.2)';
        ctx.fillRect(x + 1, y, barWidth - 2, barHeight);

        // Hour labels (every 6 hours)
        if (i % 6 === 0) {
          ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-muted').trim() || '#6e7681';
          ctx.font = '10px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(`${i}:00`, x + barWidth / 2, chartHeight + 12);
        }
      });
    }

    function renderAuthorChart(sessions) {
      const canvas = document.getElementById('authorChart');
      const ctx = canvas.getContext('2d');
      const centerX = 60;
      const centerY = 60;
      const radius = 50;
      const innerRadius = 25;

      // Count by author
      const authorCounts = {};
      sessions.forEach(s => {
        authorCounts[s.savedBy] = (authorCounts[s.savedBy] || 0) + 1;
      });

      const authors = Object.entries(authorCounts).sort((a, b) => b[1] - a[1]);
      const total = sessions.length || 1;

      ctx.clearRect(0, 0, 120, 120);

      if (authors.length === 0) {
        ctx.fillStyle = 'rgba(88, 166, 255, 0.2)';
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        ctx.arc(centerX, centerY, innerRadius, 0, Math.PI * 2, true);
        ctx.fill();
      } else {
        let startAngle = -Math.PI / 2;
        const colorMap = { blue: '#58a6ff', green: '#3fb950', purple: '#a371f7', orange: '#d29922', red: '#f85149', cyan: '#39c5cf' };

        authors.forEach(([author, count]) => {
          const sliceAngle = (count / total) * Math.PI * 2;
          const color = colorMap[getAuthorColor(author)] || '#58a6ff';

          ctx.fillStyle = color;
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
          ctx.arc(centerX, centerY, innerRadius, startAngle + sliceAngle, startAngle, true);
          ctx.closePath();
          ctx.fill();

          startAngle += sliceAngle;
        });
      }

      // Legend
      const legend = document.getElementById('authorLegend');
      const colorMap = { blue: '#58a6ff', green: '#3fb950', purple: '#a371f7', orange: '#d29922', red: '#f85149', cyan: '#39c5cf' };
      legend.innerHTML = authors.slice(0, 5).map(([author, count]) => {
        const color = colorMap[getAuthorColor(author)] || '#58a6ff';
        const pct = Math.round((count / total) * 100);
        return `<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
          <span style="width:10px;height:10px;background:${color};border-radius:2px;flex-shrink:0;"></span>
          <span>${escapeHtml(author)}</span>
          <span style="color:var(--text-muted);margin-left:auto;">${count} (${pct}%)</span>
        </div>`;
      }).join('') + (authors.length > 5 ? `<div style="color:var(--text-muted);">+${authors.length - 5} more</div>` : '');
    }

    function renderHeatmap(sessions) {
      const heatmap = document.getElementById('heatmap');
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Count sessions per day
      const dayCounts = {};
      sessions.forEach(s => {
        const date = parseDate(s.createdAt);
        date.setHours(0, 0, 0, 0);
        const key = date.toISOString().split('T')[0];
        dayCounts[key] = (dayCounts[key] || 0) + 1;
      });

      const maxCount = Math.max(...Object.values(dayCounts), 1);

      // Generate 52 weeks (364 days)
      const weeks = [];
      let currentWeek = [];

      // Start from 52 weeks ago, aligned to Sunday
      const startDate = new Date(today);
      startDate.setDate(startDate.getDate() - 364);
      const dayOfWeek = startDate.getDay();
      startDate.setDate(startDate.getDate() - dayOfWeek);

      for (let i = 0; i < 371; i++) {
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);

        if (date > today) break;

        const key = date.toISOString().split('T')[0];
        const count = dayCounts[key] || 0;

        currentWeek.push({ date, key, count });

        if (currentWeek.length === 7) {
          weeks.push(currentWeek);
          currentWeek = [];
        }
      }

      if (currentWeek.length > 0) {
        weeks.push(currentWeek);
      }

      // Render
      heatmap.innerHTML = weeks.map(week => {
        return `<div style="display:flex;flex-direction:column;gap:2px;">
          ${week.map(day => {
            let bg = 'var(--bg-tertiary)';
            if (day.count > 0) {
              const intensity = Math.min(day.count / maxCount, 1);
              if (intensity <= 0.25) bg = 'rgba(88,166,255,0.3)';
              else if (intensity <= 0.5) bg = 'rgba(88,166,255,0.5)';
              else if (intensity <= 0.75) bg = 'rgba(88,166,255,0.7)';
              else bg = 'var(--accent-blue)';
            }
            const title = `${day.key}: ${day.count} session${day.count !== 1 ? 's' : ''}`;
            return `<div style="width:10px;height:10px;background:${bg};border-radius:2px;cursor:pointer;" title="${title}" onclick="filterByDate('${day.key}')"></div>`;
          }).join('')}
        </div>`;
      }).join('');
    }

    function filterByDate(dateStr) {
      document.getElementById('filterDateFrom').value = dateStr;
      document.getElementById('filterDateTo').value = dateStr;
      applyFilters();
      showToast(`Filtered: ${dateStr}`);
    }

    function showTooltip(event, el) {
      const s = JSON.parse(el.dataset.session.replace(/&#39;/g, "'"));
      const tooltip = document.getElementById('tooltip');
      const created = parseDate(s.createdAt);
      const duration = formatDuration(parseDate(s.savedAt) - created);

      tooltip.innerHTML = `
        <strong>${escapeHtml(s.topic)}</strong><br>
        Author: ${escapeHtml(s.savedBy)}<br>
        Date: ${created.toLocaleDateString('ko-KR')}<br>
        Duration: ${duration}<br>
        Messages: ${s.messageCount}
      `;
      tooltip.style.display = 'block';
      tooltip.style.left = event.pageX + 10 + 'px';
      tooltip.style.top = event.pageY + 10 + 'px';
    }

    function hideTooltip() {
      document.getElementById('tooltip').style.display = 'none';
    }

    function scrollToSession(id) {
      const el = document.getElementById('session-' + id);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.style.borderColor = 'var(--accent-blue)';
        setTimeout(() => el.style.borderColor = '', 2000);
      }
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function toggleTheme() {
      const isLight = document.body.classList.toggle('light-theme');
      document.getElementById('themeSun').style.display = isLight ? 'none' : 'inline';
      document.getElementById('themeMoon').style.display = isLight ? 'inline' : 'none';
      localStorage.setItem('monol-theme', isLight ? 'light' : 'dark');
    }

    function showHelpModal() {
      document.getElementById('helpModal').classList.add('show');
    }

    function toggleBookmarkFilter() {
      bookmarkFilterActive = !bookmarkFilterActive;
      const btn = document.getElementById('bookmarkFilterBtn');
      if (btn) {
        btn.style.background = bookmarkFilterActive ? 'var(--accent-orange)' : '';
        btn.style.borderColor = bookmarkFilterActive ? 'var(--accent-orange)' : '';
        btn.style.color = bookmarkFilterActive ? 'white' : '';
      }
      applyFilters();
    }

    async function toggleBookmark(sessionId) {
      const isCurrentlyBookmarked = bookmarks.includes(sessionId);
      const newState = !isCurrentlyBookmarked;

      try {
        await api.toggleBookmark(sessionId, newState);
        showToast(newState ? 'Bookmarked' : 'Bookmark removed');
        applyFilters();
      } catch (e) {
        console.error('Failed to toggle bookmark:', e);
        showToast('Failed to update bookmark');
      }
    }

    function toggleSelectSession(sessionId) {
      if (selectedSessions.has(sessionId)) {
        selectedSessions.delete(sessionId);
      } else {
        if (selectedSessions.size >= 4) {
          showToast('Max 4 sessions can be selected');
          return;
        }
        selectedSessions.add(sessionId);
      }
      applyFilters();
    }

    function showCompareModal() {
      if (selectedSessions.size < 2) {
        showToast('Select at least 2 sessions to compare');
        return;
      }
      const sessions = [...selectedSessions].map(id => SESSION_DATA.find(s => s.sessionId === id)).filter(Boolean);

      let html = '<div style="display:grid;grid-template-columns:repeat(' + sessions.length + ',1fr);gap:1px;background:var(--border-color);">';

      // Headers
      sessions.forEach(s => {
        const color = getAuthorColor(s.savedBy);
        html += `<div style="background:var(--bg-secondary);padding:16px;">
          <div style="font-weight:600;margin-bottom:4px;">${escapeHtml(s.topic)}</div>
          <span class="author-badge" data-color="${color}">${escapeHtml(s.savedBy)}</span>
        </div>`;
      });

      // Rows
      const rows = [
        { label: 'Date', fn: s => parseDate(s.createdAt).toLocaleDateString('ko-KR') },
        { label: 'Duration', fn: s => formatDuration(parseDate(s.savedAt) - parseDate(s.createdAt)) },
        { label: 'Messages', fn: s => s.messageCount },
        { label: 'Session ID', fn: s => s.sessionId.substring(0, 8) }
      ];

      rows.forEach(row => {
        sessions.forEach((s, i) => {
          html += `<div style="background:var(--bg-secondary);padding:12px;font-size:14px;">
            ${i === 0 ? `<div style="color:var(--text-muted);font-size:12px;margin-bottom:4px;">${row.label}</div>` : ''}
            ${row.fn(s)}
          </div>`;
        });
      });

      html += '</div>';
      document.getElementById('compareContent').innerHTML = html;
      document.getElementById('compareModal').classList.add('show');
    }

    function showDeleteModal(sessionId) {
      currentDeleteId = sessionId;
      const session = SESSION_DATA.find(s => s.sessionId === sessionId);
      document.getElementById('deleteSessionInfo').innerHTML = `
        <strong>${escapeHtml(session.topic)}</strong><br>
        ID: ${sessionId.substring(0, 8)}<br>
        Author: ${session.savedBy}
      `;
      document.getElementById('deleteModal').classList.add('show');
    }

    async function confirmDelete() {
      if (currentDeleteId) {
        try {
          await api.deleteSession(currentDeleteId);
          selectedSessions.delete(currentDeleteId);
          showToast('Session removed');
          closeModal('deleteModal');
          applyFilters();
        } catch (e) {
          console.error('Failed to delete session:', e);
          showToast('Failed to delete session');
        }
      }
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ignore if typing in input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
        if (e.key === 'Escape') {
          e.target.blur();
        }
        return;
      }

      const sessions = getFilteredSessions();

      switch (e.key) {
        case '?':
          showHelpModal();
          break;
        case 't':
          toggleTheme();
          break;
        case '/':
          e.preventDefault();
          document.getElementById('filterTopic').focus();
          break;
        case 'Escape':
          document.querySelectorAll('.modal-overlay.show').forEach(m => m.classList.remove('show'));
          document.querySelectorAll('.session-preview.show').forEach(p => {
            p.classList.remove('show');
            p.closest('.session-card').classList.remove('expanded');
          });
          focusedSessionIndex = -1;
          applyFilters();
          break;
        case 'b':
          toggleBookmarkFilter();
          break;
        case 'c':
          if (selectedSessions.size >= 2) showCompareModal();
          break;
        case 'j':
          if (sessions.length > 0) {
            focusedSessionIndex = Math.min(focusedSessionIndex + 1, sessions.length - 1);
            applyFilters();
            scrollToSession(sessions[focusedSessionIndex].sessionId);
          }
          break;
        case 'k':
          if (sessions.length > 0) {
            focusedSessionIndex = Math.max(focusedSessionIndex - 1, 0);
            applyFilters();
            scrollToSession(sessions[focusedSessionIndex].sessionId);
          }
          break;
        case 'Enter':
          if (focusedSessionIndex >= 0 && focusedSessionIndex < sessions.length) {
            showResumeModal(sessions[focusedSessionIndex].sessionId);
          }
          break;
      }
    });

    function exportData() {
      const filtered = getFilteredSessions();
      const blob = new Blob([JSON.stringify(filtered, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sessions.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Close modal on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('show');
        }
      });
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Restore theme
      const savedTheme = localStorage.getItem('monol-theme');
      if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
        document.getElementById('themeSun').style.display = 'none';
        document.getElementById('themeMoon').style.display = 'inline';
      }

      // Load sessions from API if in server mode
      if (USE_API) {
        try {
          const { sessions } = await api.getSessions();
          SESSION_DATA = sessions;
          console.log(`Loaded ${sessions.length} sessions from API`);
        } catch (e) {
          console.error('Failed to load sessions from API:', e);
        }
      }

      populateAuthorFilter();
      applyFilters();

      // Show mode indicator
      if (USE_API) {
        showToast(`Server mode: ${API_BASE}`);
      }
    });
  </script>
</body>
</html>
